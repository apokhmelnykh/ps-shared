# Перенос групп безопасности между доменами

## Параметры запуска скрипта
`dirRootPath` - стартовая директория откуда начинать сканирование, обязательный параметр  
`groupNameLike` - фильтр по имени группы, параметр задан по умолчанию  
`dirScanLevel` - глубина обхода, параметр задан по умолчанию  
`dstDomainController` - имя котнроллера домена в целевом домене, параметр задан по умолчанию  
`dstOU` - DN путь в целевом домене, где будут созданы группы, обязательный параметр  
`csvPath` - путь к файлу в формате csv, в него сохраняем группы, которые будут созданы в целевом домене, параметр задан по умолчанию  
`srcDomain` - NetBIOS имя исходного домена  
`dstDomain` - NetBIOS имя целевого домена  
`migrateGroups` - если задан, то скрипт создаст группы в целевом домене  
`updateACL` - если задан, то скрипт обновит ACL в исходном домене

## Пример запуска
```
.\Create-GroupsFromACL.ps1 `
    -dirRootPath C:\Shared\ `
    -groupNameLike "*FA*" `
    -dstDomainController addc01.xyz.local `
    -dstOU "OU=FileAccess,OU=ADDS,DC=xyz,DC=local" `
    -srcDomain ABC `
    -dstDomain XYZ
```

## Как работает скрипт
### Block1. 
Запустите скрипт от пользователя домена из которого осуществляем перенос групп.  
Скрипт рекурсивно находит директории начиная с директории переданной в параметре `dirRootPath`.  
Далее из полученных директорий извлекаются группы безопасности с учетом фильтра по имени группы и глубины обхода.  
Из исходного домена запрашивается информация для поля "описание" групп безопасноти.  
Формируется файл в формате csv, который содержит имена и описания групп безопасности из исходного домена.  

### Block2.
В целевом домене создаются группы безопасности полученные на предыдущем шаге. Группы создаются в OU переданном в параметре `dstOU`.

### Block3.
В исходном домене изменяем ACL для директории `dirRootPath` и вложенных в нее директорий.

## Рекомендации
Для работы скрипта с параметром `updateACL` требуются права администратора.

Скрипт можно запускать несколько раз для одной и той же директории. Это не сломает уже назначенные разрешения.  
При первом запуске имеет смысл запустить без ключа `migrateGroups` и `updateACL` чтобы просто оценить список групп для миграции.  
Так же скрипт покажет уже назначенные группы из целевого домена.  

Чтобы избежать проблемы с задержкой репликации в целевом домене, запускать скрипт с ключом `updateACL` необходимо после заверешения репликации на всех контроллерах в целевом домене.

При обновлении ACL выводится информация об обработанных каталогах. Запись означает, что для указанного каталога был сформирован новый ACL и ACL был успешно применен. Сообщение выводится для всех каталогов, вне зависимости от того внесены изменения в текущий ACL или нет. Другими словами ACL обновляется каждый раз, даже тогда когда это не требуется.  

Пример вывода.
```
Block3. Update directory ACL.
+ directory permissions updated: C:\Shared\
+ directory permissions updated: C:\Shared\Exchange
+ directory permissions updated: C:\Shared\Order
+ directory permissions updated: C:\Shared\Public
```

Чтобы скоратить время работы скрипта запущенного с параметром `updateACL` рекомендуется запускать его локально, а не по сети.